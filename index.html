<!doctype html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PGRI Sehat - Doorprize</title>
  <link rel="shortcut icon" href="assets/images/98b614213cb75a54eb7bb3c9bd6bedee.png" />
  <link rel="icon" href="assets/images/c395318e9a0605d5c14ad3fc5541d502.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="assets/images/3ef23f566dd3c0cdeebc7a98a1f8643a.png" sizes="180x180" />
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Arial', sans-serif;
      /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
      background-image: url('assets/images/background.png');
      background-size: contain;
      background-repeat: no-repeat;
      /* display: flex;
      align-items: center;
      justify-content: center; */
      overflow-y: auto; 
    }

    .container {
      text-align: center;
      /* background: white; */
      /* border-radius: 20px; */
      /* box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); */
      max-width: 1000px;
      width: 95%;
      margin: 0 auto;
    }

    .container-wheel {
      text-align: center;
      padding: 20px 0;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      /* max-width: auto; */
      width: 70%;
      margin: 10px auto;
    }

    .top-logos {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 70px;
      box-sizing: border-box;
    }

    .top-logos img {
      height: 85px;
      object-fit: contain;
    }

    .title {
      font-size: 48px;
      font-weight: bold;
      /* margin-bottom: 30px; */
      color: #667eea;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .side-menu {
      position: fixed;
      left: -350px;
      top: 0;
      width: 350px;
      height: 100%;
      background: white;
      box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
      transition: left 0.3s ease;
      z-index: 2000;
      overflow-y: auto;
    }

    .side-menu.open {
      left: 0;
    }

    .side-menu-header {
      padding: 25px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .side-menu-title {
      font-size: 22px;
      font-weight: bold;
    }

    .close-menu-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-menu-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .side-menu-content {
      padding: 20px;
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .menu-section-title {
      font-size: 16px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e9ecef;
    }

    .import-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .import-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .import-btn:hover {
      background: #5568d3;
      transform: translateX(5px);
    }

    .import-btn.danger {
      background: #e74c3c;
    }

    .import-btn.danger:hover {
      background: #c0392b;
    }

    .menu-toggle-btn {
      position: fixed;
      left: 10px;
      top: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      z-index: 1500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .menu-toggle-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1900;
    }

    .menu-overlay.active {
      display: block;
    }

    .participant-count {
      font-size: 16px;
      color: #2d3436;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
    }

    .file-input {
      display: none;
    }

    .textarea-input {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 2px solid #667eea;
      border-radius: 10px;
      font-family: monospace;
      font-size: 14px;
      margin-top: 10px;
      box-sizing: border-box;
    }

    .participant-count {
      font-size: 18px;
      color: #2d3436;
      margin-top: 10px;
      font-weight: bold;
    }

    .slot-machine {
      display: flex;
      justify-content: center;
      gap: 15px;
      /* margin: 40px 0; */
      perspective: 1000px;
    }

    .reel {
      width: 90px;
      height: 120px;
      background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
      border: 4px solid #667eea;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .reel.spinning-active {
      box-shadow:
        inset 0 4px 8px rgba(0, 0, 0, 0.2),
        0 0 20px rgba(102, 126, 234, 0.6),
        0 0 40px rgba(102, 126, 234, 0.4),
        0 0 60px rgba(102, 126, 234, 0.2);
      border-color: #f093fb;
      transform: scale(1.05);
    }

    .reel.stopping-active {
      box-shadow:
        inset 0 4px 8px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(245, 87, 108, 0.8),
        0 0 60px rgba(245, 87, 108, 0.6),
        0 0 90px rgba(245, 87, 108, 0.4);
      border-color: #f5576c;
      transform: scale(1.08);
    }

    .reel-content {
      position: absolute;
      width: 100%;
      display: flex;
      flex-direction: column;
      transition: none;
    }

    .reel-content.idle {
      animation: idle-spin 5s linear infinite;
    }

    .reel-content.idle.delayed {
      animation: idle-spin-from-winner 5s linear infinite;
      animation-delay: 30s;
    }

    #reel1.idle {
      animation: idle-spin 5s linear infinite;
    }

    #reel1.idle.delayed {
      animation: idle-spin-from-winner 5s linear infinite;
      animation-delay: 30s;
    }

    #reel2.idle {
      animation: idle-spin 5.5s linear infinite;
    }

    #reel2.idle.delayed {
      animation: idle-spin-from-winner 5.5s linear infinite;
      animation-delay: 30s;
    }

    #reel3.idle {
      animation: idle-spin 6s linear infinite;
    }

    #reel3.idle.delayed {
      animation: idle-spin-from-winner 6s linear infinite;
      animation-delay: 30s;
    }

    #reel4.idle {
      animation: idle-spin 6.5s linear infinite;
    }

    #reel4.idle.delayed {
      animation: idle-spin-from-winner 6.5s linear infinite;
      animation-delay: 30s;
    }

    #reel5.idle {
      animation: idle-spin 7s linear infinite;
    }

    #reel5.idle.delayed {
      animation: idle-spin-from-winner 7s linear infinite;
      animation-delay: 30s;
    }

    #reel6.idle {
      animation: idle-spin 7.5s linear infinite;
    }

    #reel6.idle.delayed {
      animation: idle-spin-from-winner 7.5s linear infinite;
      animation-delay: 30s;
    }

    .reel-content.spinning {
      animation: fast-spin 0.02s linear infinite;
    }

    .reel-content.stopping {
      animation: stop-spin 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    @keyframes idle-spin {
      0% {
        transform: translateY(0);
      }

      25% {
        transform: translateY(-300px);
      }

      50% {
        transform: translateY(-600px);
      }

      75% {
        transform: translateY(-900px);
      }

      100% {
        transform: translateY(-1200px);
      }
    }

    @keyframes idle-spin-from-winner {
      0% {
        transform: translateY(var(--idle-start-position, 0px));
      }

      25% {
        transform: translateY(calc(var(--idle-start-position, 0px) - 300px));
      }

      50% {
        transform: translateY(calc(var(--idle-start-position, 0px) - 600px));
      }

      75% {
        transform: translateY(calc(var(--idle-start-position, 0px) - 900px));
      }

      100% {
        transform: translateY(calc(var(--idle-start-position, 0px) - 1200px));
      }
    }

    @keyframes fast-spin {
      0% {
        transform: translateY(var(--spin-offset, 0px));
      }

      100% {
        transform: translateY(calc(var(--spin-offset, 0px) - 1200px));
      }
    }

    @keyframes stop-spin {
      0% {
        transform: translateY(0);
      }

      70% {
        transform: translateY(calc(var(--final-position) + 30px));
      }

      85% {
        transform: translateY(calc(var(--final-position) - 10px));
      }

      100% {
        transform: translateY(var(--final-position));
      }
    }

    .symbol {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      font-weight: bold;
      color: #667eea;
      flex-shrink: 0;
    }

    .spin-button {
      background: linear-gradient(135deg, #fee420 0%, #fda80f 100%);
      color: white;
      border: none;
      padding: 20px 60px;
      font-size: 24px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin: 40px 0;
    }

    .spin-button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(245, 87, 108, 0.5);
    }

    .spin-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .winner-display {
      /* margin-top: 30px; */
      padding: 25px;
      background: linear-gradient(180deg, #fee420 0%, #fda80f 100%);
      border-radius: 15px;
      min-height: 60px;
      box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
    }

    .winner-text {
      font-size: 32px;
      font-weight: bold;
      color: #2d3436;
      text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
    }

    .winner-label {
      font-size: 18px;
      color: #636e72;
      margin-right: 10px;
    }

    .winner-details {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      text-align: left;
    }

    .winner-detail-row {
      display: flex;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .winner-detail-row:last-child {
      border-bottom: none;
    }

    .winner-detail-label {
      font-weight: bold;
      color: #636e72;
      min-width: 150px;
    }

    .winner-detail-value {
      color: #2d3436;
      flex: 1;
    }

    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: #f093fb;
      position: absolute;
      animation: confetti-fall 3s linear;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(100%) rotate(360deg);
        opacity: 0;
      }
    }

    .winner-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      margin: 10px 0;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 10px;
      border-left: 5px solid #667eea;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .winner-rank {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      min-width: 120px;
    }

    .winner-number {
      font-size: 24px;
      font-weight: bold;
      color: #2d3436;
      letter-spacing: 2px;
      flex: 1;
    }

    .winner-name {
      font-size: 18px;
      color: #636e72;
      text-align: right;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
    }

    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .loading {
      display: none;
      color: #667eea;
      font-weight: bold;
      margin-top: 10px;
    }

    .loading.active {
      display: block;
    }

    .error-message {
      display: none;
      color: #e74c3c;
      font-weight: bold;
      margin-top: 10px;
      padding: 10px;
      background: #fadbd8;
      border-radius: 5px;
    }

    .error-message.active {
      display: block;
    }

    .data-stats {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: left;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: bold;
      color: #636e72;
    }

    .stat-value {
      color: #2d3436;
    }
  </style>
</head>

<body>
  <!-- Menu Toggle Button -->
  <button class="menu-toggle-btn" onclick="toggleMenu()">
    <span>‚ò∞</span>
    <!-- <span>Menu Data</span> -->
  </button>

  <!-- Menu Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>

  <!-- Side Menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
      <div class="side-menu-title">üìä Data Peserta</div>
      <button class="close-menu-btn" onclick="closeMenu()">√ó</button>
    </div>
    <div class="side-menu-content">
      <div class="menu-section">
        <div class="menu-section-title">Import Data</div>
        <div class="import-buttons">
          <button class="import-btn" onclick="showLinkModal()">
            <span>üîó</span>
            <span>Link Google Sheet</span>
          </button>
          <button class="import-btn" onclick="showImportModal()">
            <span>üìã</span>
            <span>Paste Data</span>
          </button>
          <button class="import-btn" onclick="document.getElementById('csvFile').click()">
            <span>üìÅ</span>
            <span>Upload CSV</span>
          </button>
        </div>
      </div>
      <div class="menu-section">
        <div class="menu-section-title">Status</div>
        <div class="participant-count" id="participantCount">
          Belum ada data peserta
        </div>
        <div class="data-stats" id="dataStats" style="display: none;">
          <div class="stat-item">
            <span class="stat-label">Total Peserta:</span>
            <span class="stat-value" id="statTotal">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Sudah Menang:</span>
            <span class="stat-value" id="statWinners">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Belum Menang:</span>
            <span class="stat-value" id="statRemaining">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Persentase:</span>
            <span class="stat-value" id="statPercentage">0%</span>
          </div>
        </div>
      </div>
      <div class="menu-section">
        <div class="menu-section-title">Sound Effect</div>
        <div class="import-buttons">
          <button class="import-btn" onclick="document.getElementById('spinSoundFile').click()">
            <span>üéµ</span>
            <span>Upload Sound Spin</span>
          </button>
          <button class="import-btn" onclick="document.getElementById('winnerSoundFile').click()">
            <span>üéâ</span>
            <span>Upload Sound Winner</span>
          </button>
          <button class="import-btn" onclick="document.getElementById('stopSoundFile').click()">
            <span>üîä</span>
            <span>Upload Sound Stop (6x)</span>
          </button>
        </div>
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
            <span style="font-weight: bold;">Spin:</span>
            <span id="spinSoundStatus" style="color: #e74c3c;">Tidak ada</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
            <span style="font-weight: bold;">Winner:</span>
            <span id="winnerSoundStatus" style="color: #e74c3c;">Tidak ada</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-weight: bold;">Stop (6x):</span>
            <span id="stopSoundStatus" style="color: #e74c3c;">Tidak ada</span>
          </div>
        </div>
      </div>
      <div class="menu-section">
        <div class="menu-section-title">Kelola Data</div>
        <div class="import-buttons">
          <button class="import-btn danger" onclick="clearAllData()">
            <span>üóëÔ∏è</span>
            <span>Hapus Semua Data</span>
          </button>
          <button class="import-btn" onclick="exportWinners()">
            <span>üì•</span>
            <span>Export Daftar Pemenang</span>
          </button>
        </div>
      </div>
      <div class="loading" id="loadingIndicator">
        Memproses data...
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>
    <input type="file" id="csvFile" class="file-input" accept=".csv" onchange="handleFileUpload(event)">
    <input type="file" id="spinSoundFile" class="file-input" accept="audio/*"
      onchange="handleSoundUpload(event, 'spin')">
    <input type="file" id="winnerSoundFile" class="file-input" accept="audio/*"
      onchange="handleSoundUpload(event, 'winner')">
    <input type="file" id="stopSoundFile" class="file-input" accept="audio/*"
      onchange="handleSoundUpload(event, 'stop')">
  </div>

  <div class="top-logos">
    <img src="assets/images/logo.png" alt="logo">
    <img src="assets/images/logo2.png" alt="logo 2">
  </div>
  <div class="container">
    <div class="title" id="title">
      <img src="assets/images/font.png" alt="font" style="height: 240px; vertical-align: middle;">
    </div>

    <div class="slot-machine container-wheel">
      <!-- Reel 1 -->
      <div class="reel">
        <div class="reel-content idle" id="reel1">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
      <!-- Reel 2 -->
      <div class="reel">
        <div class="reel-content idle" id="reel2">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
      <!-- Reel 3 -->
      <div class="reel">
        <div class="reel-content idle" id="reel3">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
      <!-- Reel 4 -->
      <div class="reel">
        <div class="reel-content idle" id="reel4">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
      <!-- Reel 5 -->
      <div class="reel">
        <div class="reel-content idle" id="reel5">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
      <!-- Reel 6 -->
      <div class="reel">
        <div class="reel-content idle" id="reel6">
          <!-- Symbols will be generated by JavaScript -->
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 20px; justify-content: center; align-items: center;">
      <button class="spin-button" id="spinButton" onclick="spin()">PUTAR</button>
      <button class="spin-button" id="stopButton" onclick="stopSpin()"
        style="display: none; background: linear-gradient(135deg, #fda80f 0%, #c0392b 100%); box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);">STOP</button>
    </div>

    <div class="winner-display" style="display: none;" id="winnerDisplaySection">
      <div class="winner-text" id="winnerDisplay">
        <span class="winner-label">Tekan tombol untuk mulai</span>
      </div>
      <div class="winner-details" id="winnerDetails" style="display: none;"></div>
    </div>

    <div class="container">
      <div class="winners-list" id="winnersList" style="margin-top: 30px; display: none;">
        <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 15px;">
          DAFTAR PEMENANG
        </div>
        <div id="winnersContainer"></div>
      </div>
    </div>
  </div>



  <!-- Link Modal -->
  <div class="modal" id="linkModal">
    <div class="modal-content">
      <div class="modal-title">Import dari Google Sheet</div>
      <p style="color: #636e72; margin-bottom: 15px;">
        <strong>Cara menggunakan:</strong><br>
        1. Buka Google Sheet Anda<br>
        2. Klik File ‚Üí Share ‚Üí Publish to web<br>
        3. Pilih format "Comma-separated values (.csv)"<br>
        4. Copy link yang muncul dan paste di bawah
      </p>
      <input type="text" class="textarea-input" id="sheetLink"
        placeholder="Paste link Google Sheet di sini (format CSV)" style="min-height: 50px;">
      <div class="modal-buttons">
        <button class="import-btn" onclick="closeLinkModal()">Batal</button>
        <button class="import-btn" onclick="processLinkImport()">Import</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <div class="modal-title">Import Data Peserta</div>
      <p style="color: #636e72; margin-bottom: 15px;">
        Paste data dari Google Sheet atau Excel. Format: timestamp, nomor_pendaftaran, nik, nama, kategori, instansi,
        telepon, alamat
      </p>
      <textarea class="textarea-input" id="pasteArea"
        placeholder="Paste data di sini (dengan header atau tanpa header)"></textarea>
      <div class="modal-buttons">
        <button class="import-btn" onclick="closeImportModal()">Batal</button>
        <button class="import-btn" onclick="processImportData()">Import</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const defaultConfig = {
      title_text: "UNDIAN DOORPRIZE",
      button_text: "PUTAR",
      winner_label: "PEMENANG:",
      background_color: "#667eea",
      secondary_color: "#f093fb",
      text_color: "#2d3436",
      primary_action_color: "#f5576c",
      secondary_action_color: "#764ba2",
      font_family: "Arial",
      font_size: 16
    };

    let config = { ...defaultConfig };
    let isSpinning = false;
    let winners = [];
    let participants = [];
    let spinSoundData = null;
    let winnerSoundData = null;
    let stopSoundData = null; // Sound untuk setiap reel berhenti
    let spinTimeouts = [];
    let canStop = false;
    let hasSpunOnce = false;
    let spinAudio = null; // Variabel untuk mengontrol audio spin

    // Initialize the application
    function initializeApp() {
      loadParticipantsFromStorage();
      loadWinnersFromStorage();
      loadSoundsFromStorage();
      generateReelSymbols();
      updateParticipantCount();
      updateWinnersList();
      updateDataStats();

      // Show winner display section
      document.getElementById('winnerDisplaySection').style.display = 'block';
    }

    // Generate symbols for all reels
    function generateReelSymbols() {
      for (let i = 1; i <= 6; i++) {
        const reel = document.getElementById(`reel${i}`);
        reel.innerHTML = '';

        // Create 20 symbols (0-9 twice)
        for (let j = 0; j < 20; j++) {
          const symbol = document.createElement('div');
          symbol.className = 'symbol';
          symbol.textContent = j % 10;
          reel.appendChild(symbol);
        }
      }
    }

    // Load participants from localStorage
    function loadParticipantsFromStorage() {
      const stored = localStorage.getItem('participants');
      if (stored) {
        participants = JSON.parse(stored);
      }
    }

    // Save participants to localStorage
    function saveParticipantsToStorage() {
      localStorage.setItem('participants', JSON.stringify(participants));
    }

    // Load winners from localStorage
    function loadWinnersFromStorage() {
      const stored = localStorage.getItem('winners');
      if (stored) {
        winners = JSON.parse(stored);
      }
    }

    // Save winners to localStorage
    function saveWinnersToStorage() {
      localStorage.setItem('winners', JSON.stringify(winners));
    }

    function updateParticipantCount() {
      const countElement = document.getElementById('participantCount');
      if (participants.length === 0) {
        countElement.textContent = 'Belum ada data peserta';
      } else {
        const availableCount = participants.length - winners.length;
        countElement.textContent = `Total Peserta: ${participants.length} orang\nBelum menang: ${availableCount} orang`;
        countElement.style.whiteSpace = 'pre-line';
      }
    }

    function updateDataStats() {
      const dataStats = document.getElementById('dataStats');
      const statTotal = document.getElementById('statTotal');
      const statWinners = document.getElementById('statWinners');
      const statRemaining = document.getElementById('statRemaining');
      const statPercentage = document.getElementById('statPercentage');

      if (participants.length > 0) {
        dataStats.style.display = 'block';
        statTotal.textContent = participants.length;
        statWinners.textContent = winners.length;
        const remaining = participants.length - winners.length;
        statRemaining.textContent = remaining;

        const percentage = participants.length > 0 ? ((winners.length / participants.length) * 100).toFixed(1) : 0;
        statPercentage.textContent = `${percentage}%`;
      } else {
        dataStats.style.display = 'none';
      }
    }

    function toggleMenu() {
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');
      sideMenu.classList.toggle('open');
      menuOverlay.classList.toggle('active');
    }

    function closeMenu() {
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');
      sideMenu.classList.remove('open');
      menuOverlay.classList.remove('active');
    }

    function showLinkModal() {
      closeMenu();
      document.getElementById('linkModal').classList.add('active');
    }

    function closeLinkModal() {
      document.getElementById('linkModal').classList.remove('active');
      document.getElementById('sheetLink').value = '';
    }

    function showImportModal() {
      closeMenu();
      document.getElementById('importModal').classList.add('active');
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('active');
      document.getElementById('pasteArea').value = '';
    }

    function handleSoundUpload(event, type) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.type.startsWith('audio/')) {
        showError('File harus berupa audio (MP3, WAV, dll)');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const audioData = e.target.result;

        if (type === 'spin') {
          spinSoundData = audioData;
          localStorage.setItem('spinSound', audioData);
          showError(`‚úì Sound Spin berhasil diupload: ${file.name}`);
        } else if (type === 'winner') {
          winnerSoundData = audioData;
          localStorage.setItem('winnerSound', audioData);
          showError(`‚úì Sound Winner berhasil diupload: ${file.name}`);
        } else if (type === 'stop') {
          stopSoundData = audioData;
          localStorage.setItem('stopSound', audioData);
          showError(`‚úì Sound Stop berhasil diupload: ${file.name}`);
        }

        updateSoundStatus();
        event.target.value = '';
      };

      reader.onerror = function () {
        showError('Gagal membaca file audio');
        event.target.value = '';
      };

      reader.readAsDataURL(file);
    }

    function loadSoundsFromStorage() {
      const savedSpinSound = localStorage.getItem('spinSound');
      const savedWinnerSound = localStorage.getItem('winnerSound');
      const savedStopSound = localStorage.getItem('stopSound');

      if (savedSpinSound) {
        spinSoundData = savedSpinSound;
      }

      if (savedWinnerSound) {
        winnerSoundData = savedWinnerSound;
      }

      if (savedStopSound) {
        stopSoundData = savedStopSound;
      }

      updateSoundStatus();
    }

    function updateSoundStatus() {
      const spinStatus = document.getElementById('spinSoundStatus');
      const winnerStatus = document.getElementById('winnerSoundStatus');
      const stopStatus = document.getElementById('stopSoundStatus');

      if (spinSoundData) {
        spinStatus.textContent = '‚úì Aktif';
        spinStatus.style.color = '#27ae60';
      } else {
        spinStatus.textContent = 'Tidak ada';
        spinStatus.style.color = '#e74c3c';
      }

      if (winnerSoundData) {
        winnerStatus.textContent = '‚úì Aktif';
        winnerStatus.style.color = '#27ae60';
      } else {
        winnerStatus.textContent = 'Tidak ada';
        winnerStatus.style.color = '#e74c3c';
      }

      if (stopSoundData) {
        stopStatus.textContent = '‚úì Aktif';
        stopStatus.style.color = '#27ae60';
      } else {
        stopStatus.textContent = 'Tidak ada';
        stopStatus.style.color = '#e74c3c';
      }
    }

    function playSpinSound() {
      if (spinSoundData) {
        try {
          // Hentikan sound spin sebelumnya jika ada
          stopSpinSound();

          // Buat audio element baru
          spinAudio = new Audio(spinSoundData);
          spinAudio.loop = true; // Set loop ke true

          // Coba play audio
          spinAudio.play().catch(error => {
            console.error('Error playing spin sound:', error);
          });
        } catch (error) {
          console.error('Failed to create spin audio:', error);
        }
      }
    }

    function stopSpinSound() {
      if (spinAudio) {
        spinAudio.pause();
        spinAudio.currentTime = 0; // Reset ke awal
        spinAudio = null;
      }
    }

    function playStopSound() {
      if (stopSoundData) {
        try {
          const audio = new Audio(stopSoundData);
          audio.play().catch(error => {
            console.error('Error playing stop sound:', error);
          });
        } catch (error) {
          console.error('Failed to create stop audio:', error);
        }
      }
    }

    function playWinnerSound() {
      if (winnerSoundData) {
        try {
          const audio = new Audio();
          audio.src = winnerSoundData;
          audio.play().catch(error => {
            console.error('Error playing winner sound:', error);
          });
        } catch (error) {
          console.error('Failed to create winner audio:', error);
        }
      }
    }

    async function processLinkImport() {
      const linkInput = document.getElementById('sheetLink');
      const link = linkInput.value.trim();

      if (!link) {
        showError('Silakan masukkan link Google Sheet');
        return;
      }

      // Validate if it's a Google Sheets CSV link
      if (!link.includes('docs.google.com') && !link.includes('spreadsheets')) {
        showError('Link harus dari Google Sheets');
        return;
      }

      showLoading();
      closeLinkModal();

      try {
        // Convert Google Sheets link to CSV export link
        let csvLink = link;
        if (link.includes('/edit')) {
          csvLink = link.replace('/edit', '/export?format=csv');
        } else if (!link.includes('/export')) {
          csvLink = link.replace(/\/[^\/]*$/, '/export?format=csv');
        }

        const response = await fetch(csvLink);
        if (!response.ok) {
          throw new Error('Gagal mengambil data dari link');
        }

        const text = await response.text();
        document.getElementById('pasteArea').value = text;
        await processImportData();
      } catch (error) {
        hideLoading();
        showError('Gagal mengambil data: ' + error.message + '. Pastikan sheet sudah dipublish ke web.');
      }
    }

    function showLoading() {
      document.getElementById('loadingIndicator').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingIndicator').classList.remove('active');
    }

    function showError(message) {
      const errorElement = document.getElementById('errorMessage');
      errorElement.textContent = message;
      errorElement.classList.add('active');
      setTimeout(() => {
        errorElement.classList.remove('active');
      }, 5000);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());

      return result;
    }

    async function processImportData() {
      const pasteArea = document.getElementById('pasteArea');
      const data = pasteArea.value.trim();

      if (!data) {
        showError('Tidak ada data untuk diimport');
        return;
      }

      showLoading();
      closeImportModal();

      try {
        const lines = data.split('\n').filter(line => line.trim());
        let startIndex = 0;

        // Check if first line is header
        const firstLine = lines[0].toLowerCase();
        if (firstLine.includes('timestamp') || firstLine.includes('nomor_pendaftaran') || firstLine.includes('nama')) {
          startIndex = 1;
        }

        let successCount = 0;
        let errorCount = 0;
        let duplicateCount = 0;

        for (let i = startIndex; i < lines.length; i++) {
          const columns = parseCSVLine(lines[i]);

          if (columns.length >= 8) {
            const participant = {
              timestamp: columns[0] || '',
              nomor_pendaftaran: columns[1] || '',
              nik: columns[2] || '',
              nama: columns[3] || '',
              kategori: columns[4] || '',
              instansi: columns[5] || '',
              telepon: columns[6] || '',
              alamat: columns[7] || '',
              id: Date.now() + Math.random() + i // Unique ID
            };

            if (participant.nomor_pendaftaran && participant.nama) {
              // Check for duplicates based on nomor_pendaftaran
              const isDuplicate = participants.some(p =>
                p.nomor_pendaftaran === participant.nomor_pendaftaran
              );

              if (!isDuplicate) {
                participants.push(participant);
                successCount++;
              } else {
                duplicateCount++;
                errorCount++;
              }
            } else {
              errorCount++;
            }
          } else {
            errorCount++;
          }
        }

        saveParticipantsToStorage();
        updateParticipantCount();
        updateDataStats();
        hideLoading();

        let message = `Berhasil import ${successCount} peserta`;
        if (errorCount > 0) {
          message += `, ${errorCount} gagal`;
          if (duplicateCount > 0) {
            message += ` (${duplicateCount} duplikat)`;
          }
        }
        showError(message);

      } catch (error) {
        hideLoading();
        showError('Gagal memproses data: ' + error.message);
      }
    }

    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      showLoading();

      const reader = new FileReader();
      reader.onload = async function (e) {
        const text = e.target.result;
        document.getElementById('pasteArea').value = text;
        await processImportData();
        event.target.value = '';
      };
      reader.onerror = function () {
        hideLoading();
        showError('Gagal membaca file');
      };
      reader.readAsText(file);
    }

    async function clearAllData() {
      if (participants.length === 0 && winners.length === 0) {
        showError('Tidak ada data untuk dihapus');
        return;
      }

      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'modal active';
      confirmDiv.innerHTML = `
        <div class="modal-content">
          <div class="modal-title">Konfirmasi Hapus</div>
          <p>Yakin ingin menghapus semua data (${participants.length} peserta dan ${winners.length} pemenang)?</p>
          <div class="modal-buttons">
            <button class="import-btn" onclick="this.closest('.modal').remove()">Batal</button>
            <button class="import-btn danger" onclick="confirmClearData(this)">Hapus Semua</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
    }

    async function confirmClearData(button) {
      button.disabled = true;
      button.textContent = 'Menghapus...';

      participants = [];
      winners = [];
      saveParticipantsToStorage();
      saveWinnersToStorage();
      updateParticipantCount();
      updateWinnersList();
      updateDataStats();

      button.closest('.modal').remove();
      showError('Semua data berhasil dihapus');
    }

    function exportWinners() {
      if (winners.length === 0) {
        showError('Belum ada pemenang yang bisa diexport');
        return;
      }

      let csvContent = "No,Nomor Pendaftaran,Nama,NIK,Kategori,Instansi,Telepon,Alamat\n";

      winners.forEach((winner, index) => {
        const p = winner.participant;
        const row = [
          index + 1,
          `"${p.nomor_pendaftaran}"`,
          `"${p.nama}"`,
          `"${p.nik}"`,
          `"${p.kategori}"`,
          `"${p.instansi}"`,
          `"${p.telepon}"`,
          `"${p.alamat}"`
        ].join(',');
        csvContent += row + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", `daftar_pemenang_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showError(`‚úì Daftar pemenang berhasil diexport (${winners.length} orang)`);
    }

    function createConfetti() {
      const colors = ['#f093fb', '#f5576c', '#ffeaa7', '#74b9ff', '#a29bfe'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 3000);
        }, i * 30);
      }
    }

    function spinReel(reelId, duration, finalNumber, reelIndex) {
      return new Promise((resolve) => {
        const reel = document.getElementById(reelId);
        const reelContainer = reel.parentElement;

        // Remove idle state
        reel.classList.remove('idle');

        // Add spinning state
        reel.classList.add('spinning');
        reelContainer.classList.add('spinning-active');

        const timeout = setTimeout(() => {
          reel.classList.remove('spinning');
          reelContainer.classList.remove('spinning-active');
          reelContainer.classList.add('stopping-active');

          // Set final position as CSS variable for stopping animation
          const offset = -finalNumber * 120;
          reel.style.setProperty('--final-position', `${offset}px`);

          // Add stopping class
          reel.classList.add('stopping');

          // Play stop sound for this reel
          setTimeout(() => {
            playStopSound();
          }, 200); // Small delay for better timing

          // After stopping animation completes, set final position
          setTimeout(() => {
            reel.classList.remove('stopping');
            reelContainer.classList.remove('stopping-active');
            reel.style.transform = `translateY(${offset}px)`;
            reel.style.transition = 'none';
            resolve();
          }, 1500); // Match the stopping animation duration
        }, duration);

        spinTimeouts.push(timeout);
      });
    }

    async function stopSpin() {
      if (!canStop) return;

      // Hentikan sound spin
      stopSpinSound();

      // Get list of participants who haven't won yet
      const availableParticipants = participants.filter(p =>
        !winners.some(w => w.participant.id === p.id)
      );

      if (availableParticipants.length === 0) {
        showError('Semua peserta sudah pernah menang!');
        return;
      }

      // Pick random participant from available ones
      const randomIndex = Math.floor(Math.random() * availableParticipants.length);
      const randomParticipant = availableParticipants[randomIndex];
      const winnerNumber = randomParticipant.nomor_pendaftaran;

      // Extract only digits from nomor_pendaftaran
      const digitsOnly = winnerNumber.replace(/\D/g, '');

      // Pad or trim to 6 digits
      let paddedNumber = digitsOnly.padStart(6, '0');
      if (paddedNumber.length > 6) {
        paddedNumber = paddedNumber.slice(-6); // Take last 6 digits
      }

      const digits = paddedNumber.split('').map(d => parseInt(d));

      // Stop reels one by one with delay
      await Promise.all([
        spinReel('reel1', 500, digits[0], 0),
        spinReel('reel2', 800, digits[1], 1),
        spinReel('reel3', 1100, digits[2], 2),
        spinReel('reel4', 1400, digits[3], 3),
        spinReel('reel5', 1700, digits[4], 4),
        spinReel('reel6', 2000, digits[5], 5)
      ]);

      const winnerLabel = config.winner_label || defaultConfig.winner_label;
      const winnerDisplay = document.getElementById('winnerDisplay');
      const winnerDetails = document.getElementById('winnerDetails');

      winnerDisplay.innerHTML = `<span class="winner-label">${winnerLabel}</span> ${winnerNumber}`;

      // Show winner details
      winnerDetails.style.display = 'block';
      winnerDetails.innerHTML = `
        <div class="winner-detail-row">
          <div class="winner-detail-label">Nomor Pendaftaran:</div>
          <div class="winner-detail-value">${randomParticipant.nomor_pendaftaran}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">Nama:</div>
          <div class="winner-detail-value">${randomParticipant.nama}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">NIK:</div>
          <div class="winner-detail-value">${randomParticipant.nik}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">Kategori:</div>
          <div class="winner-detail-value">${randomParticipant.kategori}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">Instansi:</div>
          <div class="winner-detail-value">${randomParticipant.instansi}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">Telepon:</div>
          <div class="winner-detail-value">${randomParticipant.telepon}</div>
        </div>
        <div class="winner-detail-row">
          <div class="winner-detail-label">Alamat:</div>
          <div class="winner-detail-value">${randomParticipant.alamat}</div>
        </div>
      `;

      // Add to winners list
      winners.push({
        number: winnerNumber,
        name: randomParticipant.nama,
        participant: randomParticipant
      });
      saveWinnersToStorage();
      updateWinnersList();
      updateParticipantCount();
      updateDataStats();

      // Play winner sound
      playWinnerSound();

      createConfetti();

      // Reset reels to idle state after showing winner
      setTimeout(() => {
        document.querySelectorAll('.reel-content').forEach((reel, index) => {
          reel.classList.remove('stopping');

          // Add delay class if this is not the first spin
          if (hasSpunOnce) {
            reel.classList.add('delayed');

            // Set custom CSS property for starting position based on winner number
            const winnerDigit = digits[index];
            const startOffset = -winnerDigit * 120;
            reel.style.setProperty('--idle-start-position', `${startOffset}px`);
          }

          reel.classList.add('idle');
          reel.style.transition = 'none';
          reel.style.removeProperty('--final-position');
        });

        // Remove all reel container effects
        document.querySelectorAll('.reel').forEach(reelContainer => {
          reelContainer.classList.remove('spinning-active', 'stopping-active');
        });

        // Enable spin button based on whether we need to wait for idle animation
        const spinButton = document.getElementById('spinButton');
        if (hasSpunOnce) {
          // Keep button disabled for 60 seconds (until idle animation starts)
          setTimeout(() => {
            spinButton.disabled = false;
            spinButton.style.opacity = '1';
            spinButton.style.cursor = 'pointer';
          }, 30000); // 60 seconds delay
        } else {
          // First spin - enable immediately
          spinButton.disabled = false;
          spinButton.style.opacity = '1';
          spinButton.style.cursor = 'pointer';
        }
      }, 3000);

      // Hide stop button, show spin button
      document.getElementById('stopButton').style.display = 'none';
      document.getElementById('spinButton').style.display = 'block';

      canStop = false;
      isSpinning = false;
      spinTimeouts = [];
      hasSpunOnce = true;
    }

    async function spin() {
      if (isSpinning) return;

      if (participants.length === 0) {
        showError('Belum ada data peserta. Silakan import data terlebih dahulu.');
        return;
      }

      if (winners.length >= participants.length) {
        showError('Semua peserta sudah pernah menang!');
        return;
      }

      isSpinning = true;
      const spinButton = document.getElementById('spinButton');
      const stopButton = document.getElementById('stopButton');

      // Disable spin button immediately
      spinButton.disabled = true;
      spinButton.style.opacity = '0.6';
      spinButton.style.cursor = 'not-allowed';

      spinButton.style.display = 'none';
      stopButton.style.display = 'block';

      // Enable stop after 1 second
      setTimeout(() => {
        canStop = true;
      }, 1000);

      // Play spin sound (akan terus berulang)
      playSpinSound();

      const winnerDisplaySection = document.getElementById('winnerDisplaySection');
      const winnerDisplay = document.getElementById('winnerDisplay');
      const winnerDetails = document.getElementById('winnerDetails');

      winnerDisplaySection.style.display = 'block';
      winnerDisplay.innerHTML = '<span class="winner-label">Mengundi... Tekan STOP untuk berhenti</span>';
      winnerDetails.style.display = 'none';

      // Start spinning all reels with cascade effect
      const reels = ['reel1', 'reel2', 'reel3', 'reel4', 'reel5', 'reel6'];

      reels.forEach((reelId, index) => {
        const reel = document.getElementById(reelId);
        const reelContainer = reel.parentElement;

        // Start spinning with cascade effect
        setTimeout(() => {
          reel.classList.remove('idle', 'delayed');
          reel.classList.add('spinning');
          reelContainer.classList.add('spinning-active');

          // Reset transform when starting to spin
          reel.style.transform = '';

          // Add random offset to make each reel show different digits
          const randomOffset = Math.floor(Math.random() * 10) * 120;
          reel.style.setProperty('--spin-offset', `-${randomOffset}px`);
        }, index * 100); // 100ms delay between each reel
      });
    }

    function updateWinnersList() {
      const winnersList = document.getElementById('winnersList');
      const winnersContainer = document.getElementById('winnersContainer');

      if (winners.length > 0) {
        winnersList.style.display = 'block';
        winnersContainer.innerHTML = '';

        winners.forEach((winner, index) => {
          const winnerItem = document.createElement('div');
          winnerItem.className = 'winner-item';
          winnerItem.innerHTML = `
            <div class="winner-rank">Pemenang ${index + 1}</div>
            <div class="winner-number">${winner.number}</div>
            <div class="winner-name">${winner.name}</div>
          `;
          winnersContainer.appendChild(winnerItem);
        });
      } else {
        winnersList.style.display = 'none';
      }
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
    });
  </script>
</body>

</html>
